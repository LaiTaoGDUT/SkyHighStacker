# äº‹ä»¶ç³»ç»Ÿä½¿ç”¨æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜ SkyHighStacker é¡¹ç›®ä¸­äº‹ä»¶ç³»ç»Ÿçš„ä½¿ç”¨æ–¹æ³•ã€‚

---

## ğŸ“– æ¦‚è¿°

äº‹ä»¶ç³»ç»Ÿç”¨äºå®ç°æ¸¸æˆå„æ¨¡å—ä¹‹é—´çš„è§£è€¦é€šä¿¡ï¼Œç‰¹åˆ«æ˜¯ GameManager å’Œ UI ä¹‹é—´çš„äº¤äº’ã€‚

### æ ¸å¿ƒæ–‡ä»¶
- `EventManager.ts` - äº‹ä»¶ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
- `GameEvent` - æ¸¸æˆäº‹ä»¶ç±»å‹æšä¸¾

---

## ğŸ¯ äº‹ä»¶ç±»å‹

### æ¸¸æˆæµç¨‹äº‹ä»¶
```typescript
GameEvent.GAME_START    // æ¸¸æˆå¼€å§‹
GameEvent.GAME_PAUSE    // æ¸¸æˆæš‚åœ
GameEvent.GAME_RESUME   // æ¸¸æˆæ¢å¤
GameEvent.GAME_RESTART  // æ¸¸æˆé‡æ–°å¼€å§‹
GameEvent.GAME_OVER     // æ¸¸æˆç»“æŸ
```

### å»ºç­‘å—äº‹ä»¶
```typescript
GameEvent.BLOCK_SPAWN   // å»ºç­‘å—ç”Ÿæˆ
GameEvent.BLOCK_PLACE   // å»ºç­‘å—æ”¾ç½®
GameEvent.BLOCK_PERFECT // å®Œç¾å¯¹é½
GameEvent.BLOCK_MISS    // æœªå¯¹é½ï¼Œæ¸¸æˆç»“æŸ
```

### åˆ†æ•°å’Œé«˜åº¦äº‹ä»¶
```typescript
GameEvent.SCORE_UPDATE  // åˆ†æ•°æ›´æ–°
GameEvent.HEIGHT_UPDATE // é«˜åº¦æ›´æ–°
GameEvent.COMBO_UPDATE  // è¿å‡»æ›´æ–°
```

### UI äº‹ä»¶
```typescript
GameEvent.UI_BUTTON_CLICK // UI æŒ‰é’®ç‚¹å‡»
```

---

## ğŸš€ åŸºæœ¬ç”¨æ³•

### 1. å¯¼å…¥äº‹ä»¶ç®¡ç†å™¨

```typescript
import { eventManager, GameEvent } from './managers/EventManager';
```

### 2. ç›‘å¬äº‹ä»¶

```typescript
// åœ¨ç»„ä»¶çš„ onLoad ä¸­æ³¨å†Œäº‹ä»¶ç›‘å¬
protected onLoad(): void {
    // ç›‘å¬æ¸¸æˆå¼€å§‹äº‹ä»¶
    eventManager.on(GameEvent.GAME_START, this.onGameStart, this);
    
    // ç›‘å¬åˆ†æ•°æ›´æ–°äº‹ä»¶
    eventManager.on(GameEvent.SCORE_UPDATE, this.onScoreUpdate, this);
}

// äº‹ä»¶å¤„ç†å‡½æ•°
private onGameStart(): void {
    console.log('æ¸¸æˆå¼€å§‹äº†ï¼');
}

private onScoreUpdate(score: number): void {
    console.log('åˆ†æ•°æ›´æ–°:', score);
}
```

### 3. è§¦å‘äº‹ä»¶

```typescript
// æ— å‚æ•°äº‹ä»¶
eventManager.emit(GameEvent.GAME_START);

// å¸¦å‚æ•°äº‹ä»¶
eventManager.emit(GameEvent.SCORE_UPDATE, 100);

// å¸¦å¯¹è±¡å‚æ•°äº‹ä»¶
eventManager.emit(GameEvent.BLOCK_PLACE, {
    position: { x: 0, y: 50 },
    width: 200,
    perfect: true
});
```

### 4. å–æ¶ˆç›‘å¬

```typescript
// åœ¨ç»„ä»¶é”€æ¯æ—¶å–æ¶ˆäº‹ä»¶ç›‘å¬
protected onDestroy(): void {
    eventManager.off(GameEvent.GAME_START, this.onGameStart);
    eventManager.off(GameEvent.SCORE_UPDATE, this.onScoreUpdate);
}
```

---

## ğŸ’¡ å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: UI æŒ‰é’®è§¦å‘æ¸¸æˆå¼€å§‹

**GameUI.ts** (UIå±‚):
```typescript
import { eventManager, GameEvent } from '../managers/EventManager';

private onStartButtonClick(): void {
    console.log('[GameUI] ç‚¹å‡»å¼€å§‹æŒ‰é’®');
    
    // éšè—å¼€å§‹ç•Œé¢
    this.showGameUI();
    
    // è§¦å‘æ¸¸æˆå¼€å§‹äº‹ä»¶
    eventManager.emit(GameEvent.GAME_START);
}
```

**GameManager.ts** (é€»è¾‘å±‚):
```typescript
import { eventManager, GameEvent } from './EventManager';

protected onLoad(): void {
    // ç›‘å¬æ¸¸æˆå¼€å§‹äº‹ä»¶
    eventManager.on(GameEvent.GAME_START, this.onGameStart, this);
}

private onGameStart(): void {
    this.startGame();
}

protected onDestroy(): void {
    eventManager.off(GameEvent.GAME_START, this.onGameStart);
}
```

### æ¡ˆä¾‹ 2: åˆ†æ•°æ›´æ–°é€šçŸ¥ UI

**GameManager.ts** (é€»è¾‘å±‚):
```typescript
private calculateScore(alignmentOffset: number): void {
    // ... è®¡ç®—åˆ†æ•°é€»è¾‘ ...
    
    this.currentScore += scoreToAdd;
    
    // è§¦å‘åˆ†æ•°æ›´æ–°äº‹ä»¶
    eventManager.emit(GameEvent.SCORE_UPDATE, this.currentScore);
}
```

**GameUI.ts** (UIå±‚):
```typescript
protected onLoad(): void {
    // ç›‘å¬åˆ†æ•°æ›´æ–°äº‹ä»¶
    eventManager.on(GameEvent.SCORE_UPDATE, this.onScoreUpdate, this);
}

private onScoreUpdate(score: number): void {
    this.updateScore(score);
    
    // å¯é€‰ï¼šæ·»åŠ åˆ†æ•°åŠ¨ç”»æ•ˆæœ
    this.playScoreAnimation(score);
}
```

### æ¡ˆä¾‹ 3: å®Œç¾å¯¹é½è§¦å‘ç‰¹æ•ˆ

**GameManager.ts**:
```typescript
private calculateScore(alignmentOffset: number): void {
    if (Math.abs(alignmentOffset) <= this.perfectAlignThreshold) {
        // è§¦å‘å®Œç¾å¯¹é½äº‹ä»¶
        eventManager.emit(GameEvent.BLOCK_PERFECT, {
            position: this.currentBlock.getPosition(),
            combo: this.comboCount
        });
    }
}
```

**EffectManager.ts** (ç‰¹æ•ˆç®¡ç†å™¨):
```typescript
protected onLoad(): void {
    // ç›‘å¬å®Œç¾å¯¹é½äº‹ä»¶
    eventManager.on(GameEvent.BLOCK_PERFECT, this.onBlockPerfect, this);
}

private onBlockPerfect(data: any): void {
    const { position, combo } = data;
    
    // æ’­æ”¾ç²’å­ç‰¹æ•ˆ
    this.playPerfectEffect(position);
    
    // æ˜¾ç¤º"å®Œç¾!"æ–‡å­—
    this.showPerfectText(position, combo);
}
```

---

## ğŸ¨ é«˜çº§ç”¨æ³•

### 1. ä¸€æ¬¡æ€§äº‹ä»¶ç›‘å¬

```typescript
// åªç›‘å¬ä¸€æ¬¡ï¼Œè§¦å‘åè‡ªåŠ¨ç§»é™¤
eventManager.once(GameEvent.GAME_START, () => {
    console.log('æ¸¸æˆç¬¬ä¸€æ¬¡å¼€å§‹');
}, this);
```

### 2. æ£€æŸ¥æ˜¯å¦æœ‰ç›‘å¬å™¨

```typescript
if (eventManager.hasListeners(GameEvent.GAME_START)) {
    console.log('æœ‰ç»„ä»¶æ­£åœ¨ç›‘å¬æ¸¸æˆå¼€å§‹äº‹ä»¶');
}
```

### 3. è·å–ç›‘å¬å™¨æ•°é‡

```typescript
const count = eventManager.getListenerCount(GameEvent.GAME_START);
console.log(`æ¸¸æˆå¼€å§‹äº‹ä»¶æœ‰ ${count} ä¸ªç›‘å¬å™¨`);
```

### 4. æ¸…é™¤æŒ‡å®šäº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨

```typescript
// æ¸…é™¤æ¸¸æˆå¼€å§‹äº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨
eventManager.clear(GameEvent.GAME_START);
```

### 5. æ¸…é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨

```typescript
// åœ¨åœºæ™¯åˆ‡æ¢æˆ–æ¸¸æˆé‡ç½®æ—¶è°ƒç”¨
eventManager.clearAll();
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. è®°å¾—å–æ¶ˆç›‘å¬

**é”™è¯¯ç¤ºä¾‹**:
```typescript
protected onLoad(): void {
    eventManager.on(GameEvent.GAME_START, this.onGameStart, this);
}

// âŒ å¿˜è®°å–æ¶ˆç›‘å¬
```

**æ­£ç¡®ç¤ºä¾‹**:
```typescript
protected onLoad(): void {
    eventManager.on(GameEvent.GAME_START, this.onGameStart, this);
}

protected onDestroy(): void {
    // âœ… è®°å¾—å–æ¶ˆç›‘å¬
    eventManager.off(GameEvent.GAME_START, this.onGameStart);
}
```

### 2. ä½¿ç”¨ this ä¸Šä¸‹æ–‡

ç›‘å¬äº‹ä»¶æ—¶ï¼Œè®°å¾—ä¼ å…¥ `this` ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œä»¥ç¡®ä¿å›è°ƒå‡½æ•°ä¸­çš„ `this` æŒ‡å‘æ­£ç¡®ã€‚

```typescript
// âœ… æ­£ç¡®ï¼šä¼ å…¥ this
eventManager.on(GameEvent.GAME_START, this.onGameStart, this);

// âŒ é”™è¯¯ï¼šæœªä¼ å…¥ thisï¼Œå›è°ƒä¸­çš„ this å¯èƒ½ä¸º undefined
eventManager.on(GameEvent.GAME_START, this.onGameStart);
```

### 3. é¿å…äº‹ä»¶å¾ªç¯

ä¸è¦åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­è§¦å‘åŒä¸€ä¸ªäº‹ä»¶ï¼Œä¼šå¯¼è‡´æ— é™å¾ªç¯ã€‚

```typescript
// âŒ é”™è¯¯ï¼šä¼šå¯¼è‡´æ— é™å¾ªç¯
private onGameStart(): void {
    eventManager.emit(GameEvent.GAME_START); // è§¦å‘åŒä¸€äº‹ä»¶
}
```

### 4. äº‹ä»¶å‘½åè§„èŒƒ

å»ºè®®ä½¿ç”¨ `æ¨¡å—:åŠ¨ä½œ` çš„å‘½åæ ¼å¼ï¼š
- `game:start`
- `block:place`
- `score:update`

### 5. æ•°æ®ä¼ é€’

äº‹ä»¶å¯ä»¥ä¼ é€’ä»»ä½•ç±»å‹çš„æ•°æ®ï¼Œä½†å»ºè®®ï¼š
- ç®€å•æ•°æ®ç›´æ¥ä¼ é€’å€¼
- å¤æ‚æ•°æ®ä¼ é€’å¯¹è±¡
- é¿å…ä¼ é€’å¤§é‡æ•°æ®

```typescript
// âœ… ç®€å•æ•°æ®
eventManager.emit(GameEvent.SCORE_UPDATE, 100);

// âœ… å¤æ‚æ•°æ®
eventManager.emit(GameEvent.BLOCK_PLACE, {
    position: { x: 0, y: 50 },
    width: 200,
    perfect: true
});
```

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨æ—¥å¿—

åœ¨ `EventManager.ts` ä¸­ï¼Œå–æ¶ˆæ³¨é‡Šæ—¥å¿—è¯­å¥ï¼š

```typescript
public on(event: string, callback: EventCallback, target?: any): void {
    // ... ä»£ç  ...
    
    console.log(`[EventManager] ç›‘å¬äº‹ä»¶: ${event}`); // å–æ¶ˆæ³¨é‡Š
}

public emit(event: string, data?: any): void {
    // ... ä»£ç  ...
    
    console.log(`[EventManager] è§¦å‘äº‹ä»¶: ${event}`, data); // å–æ¶ˆæ³¨é‡Š
}
```

### 2. æŸ¥çœ‹æ‰€æœ‰ç›‘å¬å™¨

åœ¨æ§åˆ¶å°ä¸­æ‰§è¡Œï¼š

```typescript
// æŸ¥çœ‹äº‹ä»¶ç®¡ç†å™¨å®ä¾‹
console.log(eventManager);

// æŸ¥çœ‹æŒ‡å®šäº‹ä»¶çš„ç›‘å¬å™¨æ•°é‡
console.log(eventManager.getListenerCount(GameEvent.GAME_START));
```

---

## ğŸ“Š äº‹ä»¶æµç¨‹å›¾

### æ¸¸æˆå¼€å§‹æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"æŒ‰é’®
    â†“
GameUI è§¦å‘ GAME_START äº‹ä»¶
    â†“
GameManager ç›‘å¬åˆ°äº‹ä»¶
    â†“
GameManager.startGame() æ‰§è¡Œ
    â†“
ç”Ÿæˆå»ºç­‘å—ã€æ›´æ–°UIç­‰
```

### åˆ†æ•°æ›´æ–°æµç¨‹

```
å»ºç­‘å—æ”¾ç½®æˆåŠŸ
    â†“
GameManager è®¡ç®—åˆ†æ•°
    â†“
è§¦å‘ SCORE_UPDATE äº‹ä»¶
    â†“
GameUI ç›‘å¬åˆ°äº‹ä»¶
    â†“
æ›´æ–°åˆ†æ•°æ˜¾ç¤º
    â†“
å¯é€‰ï¼šè§¦å‘åˆ†æ•°åŠ¨ç”»
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é›†ä¸­ç®¡ç†äº‹ä»¶ç±»å‹

æ‰€æœ‰äº‹ä»¶ç±»å‹éƒ½å®šä¹‰åœ¨ `GameEvent` æšä¸¾ä¸­ï¼Œé¿å…ä½¿ç”¨å­—ç¬¦ä¸²å­—é¢é‡ã€‚

```typescript
// âœ… æ­£ç¡®
eventManager.emit(GameEvent.GAME_START);

// âŒ é”™è¯¯
eventManager.emit('game:start');
```

### 2. äº‹ä»¶æ•°æ®ç»“æ„åŒ–

å¯¹äºå¤æ‚äº‹ä»¶æ•°æ®ï¼Œå®šä¹‰æ¥å£ï¼š

```typescript
interface BlockPlaceData {
    position: { x: number; y: number };
    width: number;
    perfect: boolean;
}

eventManager.emit(GameEvent.BLOCK_PLACE, {
    position: { x: 0, y: 50 },
    width: 200,
    perfect: true
} as BlockPlaceData);
```

### 3. åœ¨åˆé€‚çš„ç”Ÿå‘½å‘¨æœŸæ³¨å†Œ/å–æ¶ˆäº‹ä»¶

- `onLoad`: æ³¨å†Œäº‹ä»¶
- `onDestroy`: å–æ¶ˆäº‹ä»¶
- é¿å…åœ¨ `update` ä¸­æ³¨å†Œ/å–æ¶ˆäº‹ä»¶

### 4. é”™è¯¯å¤„ç†

äº‹ä»¶å›è°ƒä¸­çš„é”™è¯¯ä¼šè¢«è‡ªåŠ¨æ•è·ï¼Œä¸ä¼šå½±å“å…¶ä»–ç›‘å¬å™¨ï¼š

```typescript
private onGameStart(): void {
    try {
        // ä½ çš„é€»è¾‘
    } catch (error) {
        console.error('æ¸¸æˆå¼€å§‹å¤±è´¥', error);
    }
}
```

---

## ğŸ†š å¯¹æ¯”å…¶ä»–æ–¹æ¡ˆ

### äº‹ä»¶ç³»ç»Ÿ vs ç›´æ¥è°ƒç”¨

**ç›´æ¥è°ƒç”¨**ï¼ˆä¸æ¨èï¼‰:
```typescript
// GameUI.ts
private onStartButtonClick(): void {
    GameManager.instance.startGame(); // å¼ºè€¦åˆ
}
```

**äº‹ä»¶ç³»ç»Ÿ**ï¼ˆæ¨èï¼‰:
```typescript
// GameUI.ts
private onStartButtonClick(): void {
    eventManager.emit(GameEvent.GAME_START); // è§£è€¦
}
```

**ä¼˜åŠ¿**:
- âœ… è§£è€¦ï¼šUI å’Œ GameManager ä¸ç›´æ¥ä¾èµ–
- âœ… çµæ´»ï¼šå¤šä¸ªæ¨¡å—å¯ä»¥ç›‘å¬åŒä¸€äº‹ä»¶
- âœ… æ‰©å±•ï¼šæ·»åŠ æ–°åŠŸèƒ½æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 

---

## ğŸ“š æ‰©å±•é˜…è¯»

- Cocos Creator äº‹ä»¶ç³»ç»Ÿæ–‡æ¡£
- è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰
- å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼ˆPub-Sub Patternï¼‰

---

## ğŸ‰ æ€»ç»“

äº‹ä»¶ç³»ç»Ÿæ˜¯ SkyHighStacker é¡¹ç›®çš„æ ¸å¿ƒé€šä¿¡æœºåˆ¶ï¼š

1. **ä½¿ç”¨ `eventManager.on()` ç›‘å¬äº‹ä»¶**
2. **ä½¿ç”¨ `eventManager.emit()` è§¦å‘äº‹ä»¶**
3. **ä½¿ç”¨ `eventManager.off()` å–æ¶ˆç›‘å¬**
4. **è®°å¾—åœ¨ `onDestroy` ä¸­æ¸…ç†äº‹ä»¶ç›‘å¬å™¨**

éµå¾ªè¿™äº›è§„åˆ™ï¼Œå°±èƒ½è½»æ¾ä½¿ç”¨äº‹ä»¶ç³»ç»Ÿå®ç°æ¨¡å—é—´é€šä¿¡ï¼ğŸš€

