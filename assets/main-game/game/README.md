# 主游戏模块 - 摩天叠叠乐

## 模块概述

这是主游戏的核心模块，包含了游戏的所有逻辑、UI、场景和资源。

## 目录结构

```
game/
├── scenes/                      # 游戏场景
│   ├── MainGame.scene          # 主游戏场景文件
│   └── 场景搭建指南.md         # 场景搭建详细说明
├── scripts/                     # 游戏脚本
│   ├── managers/               # 管理器
│   │   └── GameManager.ts     # 游戏管理器（核心控制）
│   ├── blocks/                 # 建筑块相关
│   │   ├── Block.ts           # 单个建筑块组件
│   │   └── BlockController.ts # 建筑块控制器
│   ├── background/             # 背景系统
│   │   └── BackgroundController.ts # 背景控制器
│   ├── ui/                     # UI 界面
│   │   └── GameUI.ts          # 游戏UI控制器
│   ├── utils/                  # 工具类（待添加）
│   └── CameraFollow.ts        # 摄像机跟随控制器
├── prefabs/                    # 预制体（待创建）
│   └── Block.prefab           # 建筑块预制体（需在编辑器中创建）
├── resources/                  # 游戏资源（待添加）
└── README.md                   # 本文档
```

## 核心组件说明

### 1. GameManager (游戏管理器)

**职责**：
- 游戏整体流程控制（开始、暂停、恢复、结束）
- 分数计算和管理
- 难度递增控制
- 建筑块生成协调
- 各系统间的通信协调

**关键方法**：
- `startGame()` - 开始游戏
- `pauseGame()` - 暂停游戏
- `resumeGame()` - 恢复游戏
- `gameOver()` - 游戏结束
- `restartGame()` - 重新开始
- `placeBlock()` - 放置建筑块
- `calculateScore()` - 计算分数
- `updateHeight()` - 更新高度

**配置参数**：
- Initial Block Speed: 初始建筑块移动速度
- Speed Increment: 每层速度增量
- Perfect Align Threshold: 完美对齐阈值
- Perfect Align Bonus: 完美对齐奖励分数
- Normal Align Score: 普通对齐分数
- Combo Multiplier: 连击倍数

### 2. BlockController (建筑块控制器)

**职责**：
- 建筑块对象池管理
- 建筑块生成和回收
- 建筑块对齐和裁剪计算
- 掉落碎片生成

**关键方法**：
- `spawnBlock()` - 生成建筑块
- `stopCurrentBlock()` - 停止当前建筑块
- `calculateOverlap()` - 计算重叠区域
- `trimBlock()` - 裁剪建筑块
- `spawnFallingPiece()` - 生成掉落碎片
- `getTotalHeight()` - 获取总高度

### 3. Block (建筑块组件)

**职责**：
- 单个建筑块的移动逻辑
- 水平往返运动
- 尺寸调整（裁剪后）
- 状态管理（移动中、已固定）

**关键方法**：
- `initialize()` - 初始化建筑块
- `stopMoving()` - 停止移动
- `fix()` - 固定建筑块
- `adjustWidth()` - 调整宽度
- `setColor()` - 设置颜色

### 4. BackgroundController (背景控制器)

**职责**：
- 根据高度动态切换背景
- 实现视差滚动效果
- 背景层管理

**背景层级**：
- Ground Layer: 0-500m（地面）
- City Layer: 500-1500m（城市）
- Sky Layer: 1500-3000m（天空）
- Space Layer: 3000m+（太空）

**关键方法**：
- `updateBackground()` - 更新背景
- `switchToLayer()` - 切换背景层
- `updateParallax()` - 更新视差滚动

### 5. GameUI (游戏UI控制器)

**职责**：
- 显示游戏信息（分数、高度、连击）
- 管理各种UI面板（开始、暂停、结束）
- 按钮事件处理

**UI 面板**：
- Start Panel - 开始界面
- Game UI - 游戏中界面
- Pause Panel - 暂停界面
- Game Over Panel - 游戏结束界面

**关键方法**：
- `updateScore()` - 更新分数显示
- `updateHeight()` - 更新高度显示
- `updateCombo()` - 更新连击显示
- `showGameOver()` - 显示游戏结束界面
- `showPerfectHint()` - 显示完美对齐提示

### 6. CameraFollow (摄像机跟随)

**职责**：
- 平滑跟随建筑物高度
- 使用平滑阻尼算法实现自然跟随效果

**关键方法**：
- `startFollow()` - 开始跟随
- `stopFollow()` - 停止跟随
- `updateTargetHeight()` - 更新目标高度
- `snapToTarget()` - 立即移动到目标位置

## 游戏流程

### 1. 游戏初始化
```
GameManager.onLoad()
  ├── 初始化组件引用
  ├── 注册输入事件
  └── 显示开始界面
```

### 2. 游戏开始
```
玩家点击屏幕
  ├── GameManager.startGame()
  ├── 生成第一个建筑块（地基）
  ├── 生成第二个移动的建筑块
  └── 摄像机开始跟随
```

### 3. 游戏循环
```
建筑块水平移动
  ├── 玩家点击屏幕
  ├── 停止建筑块移动
  ├── 计算与下方建筑块的对齐度
  ├── 裁剪未对齐部分
  ├── 计算分数（普通/完美）
  ├── 更新高度
  ├── 更新背景和摄像机
  └── 生成下一个建筑块
```

### 4. 游戏结束
```
建筑块完全未对齐
  ├── GameManager.gameOver()
  ├── 停止游戏
  ├── 显示最终分数和高度
  └── 显示游戏结束界面
```

## 核心玩法机制

### 1. 建筑块移动

- 建筑块在屏幕上方水平往返移动
- 移动速度随高度递增
- 移动范围可配置

### 2. 对齐判定

**完美对齐**：
- 误差在 5 像素以内
- 奖励 50 分
- 增加连击计数
- 连击有额外加成（每次+10%）

**普通对齐**：
- 有一定重叠
- 奖励 10 分
- 打断连击

**未对齐**：
- 无重叠或重叠太少
- 游戏结束

### 3. 建筑块裁剪

- 计算两个建筑块的重叠区域
- 裁剪掉未对齐的部分
- 未对齐部分可以添加掉落动画

### 4. 难度递增

- 每放置一个建筑块，移动速度增加
- 可选：建筑块尺寸逐渐减小
- 可选：移动范围逐渐增大

### 5. 背景变化

根据高度自动切换背景：
- 0-500m: 地面景观
- 500-1500m: 城市景观
- 1500-3000m: 天空景观
- 3000m+: 太空景观

## 开发状态

### ✅ 已完成
- [x] 目录结构创建
- [x] GameManager 脚本
- [x] BlockController 脚本
- [x] Block 组件脚本
- [x] BackgroundController 脚本
- [x] GameUI 脚本
- [x] CameraFollow 脚本
- [x] 场景文件基础结构
- [x] 场景搭建指南文档

### 🚧 待完成
- [ ] 在编辑器中搭建完整场景
- [ ] 创建建筑块预制体
- [ ] 准备背景图片资源
- [ ] 实现对象池系统
- [ ] 完善建筑块放置逻辑
- [ ] 添加建筑块裁剪和掉落动画
- [ ] 实现数据持久化（最高分）
- [ ] 添加音效系统
- [ ] 添加粒子特效
- [ ] 性能优化

### 📋 TODO 详细列表

#### Phase 1 - 核心功能实现
1. **建筑块系统**
   - [ ] 完善 Block 组件的移动逻辑
   - [ ] 实现建筑块对象池
   - [ ] 实现建筑块裁剪逻辑
   - [ ] 添加掉落动画
   - [ ] 添加颜色渐变效果

2. **游戏逻辑**
   - [ ] 完善建筑块放置逻辑
   - [ ] 实现碰撞检测
   - [ ] 完善分数计算
   - [ ] 实现连击系统
   - [ ] 添加游戏结束判定

3. **UI 完善**
   - [ ] 在编辑器中搭建所有 UI 界面
   - [ ] 实现按钮事件连接
   - [ ] 添加 UI 动画效果
   - [ ] 实现完美对齐提示动画

#### Phase 2 - 视觉效果
1. **背景系统**
   - [ ] 准备4套背景图片
   - [ ] 实现背景平滑切换
   - [ ] 添加背景视差滚动
   - [ ] 添加背景装饰元素

2. **特效系统**
   - [ ] 完美对齐粒子特效
   - [ ] 建筑块掉落粒子特效
   - [ ] 连击文字动画
   - [ ] 分数增加动画

3. **摄像机效果**
   - [ ] 完善摄像机跟随逻辑
   - [ ] 添加摄像机震动效果
   - [ ] 添加镜头缓动效果

#### Phase 3 - 优化和完善
1. **性能优化**
   - [ ] 对象池优化
   - [ ] 渲染批处理
   - [ ] 资源加载优化
   - [ ] 内存管理优化

2. **数据系统**
   - [ ] 实现本地存储
   - [ ] 最高分记录
   - [ ] 游戏设置保存
   - [ ] 统计数据记录

3. **音效系统**
   - [ ] 添加背景音乐
   - [ ] 添加点击音效
   - [ ] 添加完美对齐音效
   - [ ] 添加游戏结束音效

## 使用说明

### 如何开始

1. **打开场景**
   - 在 Cocos Creator 中打开 `MainGame.scene`

2. **搭建场景**
   - 参考 `场景搭建指南.md` 文档
   - 按照指南逐步搭建场景节点
   - 关联所有组件引用

3. **创建预制体**
   - 创建建筑块预制体
   - 添加 Block 组件
   - 关联到 BlockController

4. **准备资源**
   - 添加背景图片到 resources 目录
   - 添加 UI 图片资源
   - 添加音效文件（可选）

5. **测试运行**
   - 点击 Cocos Creator 的运行按钮
   - 测试游戏流程
   - 调试和优化

### 调试技巧

1. **查看日志**
   - 所有组件都有详细的 console.log 输出
   - 使用浏览器开发者工具查看控制台

2. **检查组件引用**
   - 确保所有 @property 装饰的属性都已在编辑器中关联
   - 运行时检查 null 引用

3. **性能监控**
   - 使用 Cocos Creator 的性能统计面板
   - 监控帧率和内存使用

## 扩展建议

### 1. 玩法扩展
- 多种建筑块形状
- 特殊道具（如时间减慢、自动对齐）
- 不同难度模式
- 每日挑战模式
- 成就系统

### 2. 视觉扩展
- 多套主题皮肤
- 天气效果
- 昼夜变化
- 建筑物特效

### 3. 社交扩展
- 排行榜系统
- 好友对战
- 分享功能
- 录像回放

## 技术要点

### 1. 对象池模式
建筑块使用对象池管理，避免频繁创建销毁，提升性能。

### 2. 组件化设计
每个功能模块都是独立的组件，便于维护和扩展。

### 3. 事件驱动
使用事件系统进行组件间通信，降低耦合度。

### 4. 状态机模式
游戏状态使用枚举管理，清晰明确。

### 5. 平滑算法
摄像机跟随使用平滑阻尼算法，提供自然的视觉体验。

## 参考资料

- [Cocos Creator 官方文档](https://docs.cocos.com/creator/3.8/manual/)
- [TypeScript 官方文档](https://www.typescriptlang.org/docs/)
- 游戏参考：《Stack》、《都市摩天楼》

## 联系方式

如有问题或建议，请参考项目根目录的开发规范文档。

---

**最后更新**: 2025-12-29
**版本**: v0.1.0
**状态**: 开发中

